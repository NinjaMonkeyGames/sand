name: CI/CD Deployment Pipeline

on:
  push:
    branches:
      - master
      - release
      - develop
      - 'feature/**'

jobs:
  determine-env:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      target_env: ${{ steps.set-env.outputs.target_env }}
    steps:
      - id: set-env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "target_env=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/heads/release ]]; then
            echo "target_env=release" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "target_env=staging" >> $GITHUB_OUTPUT
          else
            echo "target_env=development" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to Environment
    needs: determine-env
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-env.outputs.target_env }}
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Display Detected Environment
        run: |
          echo "------------------------------------------------"
          echo "‚úÖ DEPLOYMENT COMPLETE"
          echo "Detected Branch: ${{ github.ref_name }}"
          echo "Target Environment: ${{ needs.determine-env.outputs.target_env }}"
          echo "------------------------------------------------"
          
      - name: Verify Environment YAML Files
        run: |
          echo "Verifying the presence of environment-specific YAML files..."
          ls -l production.yaml release.yaml staging.yaml development.yaml || { echo "Error: One or more environment YAML files are missing."; exit 1; }

      - name: Deploy using the correct YAML file
        id: deploy
        run: |
          set -e  # Fail the script on any command that exits with a non-zero status
          set -x  # Print commands as they are executed
          
          ENV=${{ needs.determine-env.outputs.target_env }}
          echo "üöÄ Deploying to $ENV environment..."
          
          case "$ENV" in
            production)
              echo "Using production.yaml"
              kubectl apply -f production.yaml || { echo "Error deploying to production"; exit 1; }
              ;;
            release)
              echo "Using release.yaml"
              kubectl apply -f release.yaml || { echo "Error deploying to release"; exit 1; }
              ;;
            staging)
              echo "Using staging.yaml"
              kubectl apply -f staging.yaml || { echo "Error deploying to staging"; exit 1; }
              ;;
            development)
              echo "Using development.yaml"
              kubectl apply -f development.yaml || { echo "Error deploying to development"; exit 1; }
              ;;
            *)
              echo "Unknown environment: $ENV"
              exit 1
              ;;
          esac

      - name: Mark deployment as successful
        if: ${{ success() }}
        run: |
          echo "üöÄ Deployment to ${{ needs.determine-env.outputs.target_env }} completed successfully!"

      - name: Handle deployment failure
        if: ${{ failure() }}
        run: |
          echo "‚ùå Deployment to ${{ needs.determine-env.outputs.target_env }} failed."
          exit 1
