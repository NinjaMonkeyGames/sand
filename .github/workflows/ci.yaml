name: CI + Environment-aware Deployment

on:
  push:
    branches:
      - master  
      - develop
      - 'release/**'
      - 'hotfix/**'
      - 'feature/**'
      - 'bugfix/**'
  pull_request:
    branches:
      - master
      - develop

jobs:
  determine-environment:
    runs-on: ubuntu-latest
    # This job runs always — used to compute environment name
    outputs:
      environment: ${{ steps.detect.outputs.env_name }}
      short_env:   ${{ steps.detect.outputs.short_env }}
      is_deploy:   ${{ steps.detect.outputs.is_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect GitFlow environment
        id: detect
        run: |
          BRANCH="${{ github.ref_name }}"
          EVENT="${{ github.event_name }}"

          echo "Branch: $BRANCH"
          echo "Event: $EVENT"

          if [[ "$EVENT" == "pull_request" ]]; then
            ENV_NAME="preview / PR"
            SHORT_ENV="pr"
            IS_DEPLOY="false"
          elif [[ "$BRANCH" == "master" ]]; then
            ENV_NAME="production"
            SHORT_ENV="prod"
            IS_DEPLOY="true"
          elif [[ "$BRANCH" == "develop" ]]; then
            ENV_NAME="staging"
            SHORT_ENV="staging"
            IS_DEPLOY="true"
          elif [[ "$BRANCH" =~ ^release/ ]]; then
            ENV_NAME="release candidate"
            SHORT_ENV="rc"
            IS_DEPLOY="true"
          elif [[ "$BRANCH" =~ ^hotfix/ ]]; then
            ENV_NAME="hotfix / production patch"
            SHORT_ENV="hotfix"
            IS_DEPLOY="true"
          elif [[ "$BRANCH" =~ ^(feature|bugfix)/ ]]; then
            ENV_NAME="feature / development preview"
            SHORT_ENV="feature"
            IS_DEPLOY="false"   # usually no real deploy, or deploy to preview env
          else
            ENV_NAME="unknown-environment"
            SHORT_ENV="unknown"
            IS_DEPLOY="false"
          fi

          echo "env_name=$ENV_NAME"   >> $GITHUB_OUTPUT
          echo "short_env=$SHORT_ENV" >> $GITHUB_OUTPUT
          echo "is_deploy=$IS_DEPLOY" >> $GITHUB_OUTPUT

          echo "Detected environment → $ENV_NAME"

  build-and-test:
    needs: determine-environment
    runs-on: ubuntu-latest
    
  deploy:
    needs: [determine-environment, build-and-test]
    if: ${{ needs.determine-environment.outputs.is_deploy == 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.short_env }}
    # ↑ This line connects to GitHub Environments (for secrets & protection rules)

    steps:
      - uses: actions/checkout@v4

      - name: Show detected environment
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════╗"
          echo "║            DEPLOYMENT TARGET                 ║"
          echo "╠══════════════════════════════════════════════╣"
          echo "║ Environment : ${{ needs.determine-environment.outputs.environment }}"
          echo "║ Short name  : ${{ needs.determine-environment.outputs.short_env }}"
          echo "║ Branch      : ${{ github.ref_name }}"
          echo "║ Commit      : ${{ github.sha }}"
          echo "╚══════════════════════════════════════════════╝"
          echo ""

      # ── Add your real deployment steps here ────────────────────────────────
      # Examples:

      #- name: Deploy to Vercel (Production)
      #  if: needs.determine-environment.outputs.short_env == 'prod'
      #  run: npx vercel --prod --token ${{ secrets.VERCEL_TOKEN }}

      #- name: Deploy to Staging (Netlify / Render / Railway / ...)
      #  if: needs.determine-environment.outputs.short_env == 'staging'
      #  run: |

      #- name: Deploy Release Candidate
      #  if: startsWith(needs.determine-environment.outputs.short_env, 'rc')
      #  run: echo "Would deploy to release preview environment..."

      - name: Deployment simulation complete
        run: |
          echo "Deployment steps for ${{ needs.determine-environment.outputs.environment }} completed (or simulated)."
          echo "Environment confirmed: ${{ needs.determine-environment.outputs.environment }}"