name: CI Controller

on:
  push:
    branches:
      - 'feature/**'
      - 'develop'
      - 'release'
      - 'master'
  workflow_dispatch:
    inputs:
      force_env:
        description: 'Manually override and pick an environment'
        required: false
        type: choice
        options:
          - development
          - staging
          - release
          - production

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-env:
    runs-on: ubuntu-latest
    outputs:
      env_name: ${{ steps.branch-check.outputs.env }}
    steps:
      - id: branch-check
        shell: bash
        run: |
          # 1. Check if a manual override was provided via workflow_dispatch
          # 2. Otherwise, map the branch name to the environment
          if [[ "${{ github.event.inputs.force_env }}" != "" ]]; then
            ENV="${{ github.event.inputs.force_env }}"
          elif [[ $GITHUB_REF_NAME == feature/* ]]; then
            ENV="development"
          elif [[ $GITHUB_REF_NAME == "develop" ]]; then
            ENV="staging"
          elif [[ $GITHUB_REF_NAME == "release" ]]; then
            ENV="release"
          elif [[ $GITHUB_REF_NAME == "master" ]]; then
            ENV="production"
          else
            echo "::error::Branch $GITHUB_REF_NAME is not mapped to an environment."
            exit 1
          fi
          
          echo "env=$ENV" >> $GITHUB_OUTPUT

  # -------------------------------------------------------------------------
  # Reusable Workflow Calls
  # -------------------------------------------------------------------------

  development-call:
    needs: detect-env
    if: needs.detect-env.outputs.env_name == 'development'
    uses: ./.github/workflows/development.yaml
    secrets: inherit

  staging-call:
    needs: detect-env
    if: needs.detect-env.outputs.env_name == 'staging'
    uses: ./.github/workflows/staging.yaml
    secrets: inherit

  release-call:
    needs: detect-env
    if: needs.detect-env.outputs.env_name == 'release'
    uses: ./.github/workflows/release.yaml
    secrets: inherit

  production-call:
    needs: detect-env
    if: needs.detect-env.outputs.env_name == 'production'
    uses: ./.github/workflows/production.yaml
    secrets: inherit
